{"ast":null,"code":"/*! @azure/msal-common v6.1.0 2022-02-08 */\n'use strict';\n\nimport { __awaiter, __generator, __assign } from '../_virtual/_tslib.js';\nimport { AuthToken } from '../account/AuthToken.js';\nimport { TimeUtils } from '../utils/TimeUtils.js';\nimport { UrlString } from '../url/UrlString.js';\nimport { ClientAuthError } from '../error/ClientAuthError.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\nvar KeyLocation;\n\n(function (KeyLocation) {\n  KeyLocation[\"SW\"] = \"sw\";\n  KeyLocation[\"UHW\"] = \"uhw\";\n})(KeyLocation || (KeyLocation = {}));\n\nvar PopTokenGenerator =\n/** @class */\nfunction () {\n  function PopTokenGenerator(cryptoUtils) {\n    this.cryptoUtils = cryptoUtils;\n  }\n\n  PopTokenGenerator.prototype.generateCnf = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var reqCnf;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.generateKid(request)];\n\n          case 1:\n            reqCnf = _a.sent();\n            return [2\n            /*return*/\n            , this.cryptoUtils.base64Encode(JSON.stringify(reqCnf))];\n        }\n      });\n    });\n  };\n\n  PopTokenGenerator.prototype.generateKid = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var kidThumbprint;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.cryptoUtils.getPublicKeyThumbprint(request)];\n\n          case 1:\n            kidThumbprint = _a.sent();\n            return [2\n            /*return*/\n            , {\n              kid: kidThumbprint,\n              xms_ksl: KeyLocation.SW\n            }];\n        }\n      });\n    });\n  };\n\n  PopTokenGenerator.prototype.signPopToken = function (accessToken, request) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var tokenClaims;\n      return __generator(this, function (_b) {\n        tokenClaims = AuthToken.extractTokenClaims(accessToken, this.cryptoUtils);\n\n        if (!((_a = tokenClaims === null || tokenClaims === void 0 ? void 0 : tokenClaims.cnf) === null || _a === void 0 ? void 0 : _a.kid)) {\n          throw ClientAuthError.createTokenClaimsRequiredError();\n        }\n\n        return [2\n        /*return*/\n        , this.signPayload(accessToken, tokenClaims.cnf.kid, request)];\n      });\n    });\n  };\n\n  PopTokenGenerator.prototype.signPayload = function (payload, kid, request, claims) {\n    return __awaiter(this, void 0, void 0, function () {\n      var resourceRequestMethod, resourceRequestUri, shrClaims, shrNonce, resourceUrlString, resourceUrlComponents;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            resourceRequestMethod = request.resourceRequestMethod, resourceRequestUri = request.resourceRequestUri, shrClaims = request.shrClaims, shrNonce = request.shrNonce;\n            resourceUrlString = resourceRequestUri ? new UrlString(resourceRequestUri) : undefined;\n            resourceUrlComponents = resourceUrlString === null || resourceUrlString === void 0 ? void 0 : resourceUrlString.getUrlComponents();\n            return [4\n            /*yield*/\n            , this.cryptoUtils.signJwt(__assign({\n              at: payload,\n              ts: TimeUtils.nowSeconds(),\n              m: resourceRequestMethod === null || resourceRequestMethod === void 0 ? void 0 : resourceRequestMethod.toUpperCase(),\n              u: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.HostNameAndPort,\n              nonce: shrNonce || this.cryptoUtils.createNewGuid(),\n              p: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.AbsolutePath,\n              q: (resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.QueryString) ? [[], resourceUrlComponents.QueryString] : undefined,\n              client_claims: shrClaims || undefined\n            }, claims), kid)];\n\n          case 1:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n\n  return PopTokenGenerator;\n}();\n\nexport { PopTokenGenerator };","map":{"version":3,"mappings":"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","names":["KeyLocation","cryptoUtils","PopTokenGenerator","request","generateKid","reqCnf","_a","base64Encode","JSON","stringify","getPublicKeyThumbprint","kidThumbprint","kid","xms_ksl","SW","accessToken","tokenClaims","AuthToken","extractTokenClaims","cnf","ClientAuthError","createTokenClaimsRequiredError","signPayload","payload","claims","resourceRequestMethod","resourceRequestUri","shrClaims","shrNonce","resourceUrlString","UrlString","undefined","resourceUrlComponents","getUrlComponents","signJwt","__assign","at","ts","TimeUtils","nowSeconds","m","toUpperCase","u","HostNameAndPort","nonce","createNewGuid","p","AbsolutePath","q","QueryString","client_claims"],"sources":["C:\\Users\\empti\\OneDrive\\Desktop\\User_Interface\\user_interface_frontend\\node_modules\\@azure\\msal-common\\src\\crypto\\PopTokenGenerator.ts"],"sourcesContent":["/*\n * Copyright (c) Microsoft Corporation. All rights reserved.\n * Licensed under the MIT License.\n */\n\nimport { ICrypto, SignedHttpRequestParameters } from \"./ICrypto\";\nimport { AuthToken } from \"../account/AuthToken\";\nimport { TokenClaims } from \"../account/TokenClaims\";\nimport { TimeUtils } from \"../utils/TimeUtils\";\nimport { UrlString } from \"../url/UrlString\";\nimport { ClientAuthError } from \"../error/ClientAuthError\";\n\n/**\n * See eSTS docs for more info.\n * - A kid element, with the value containing an RFC 7638-compliant JWK thumbprint that is base64 encoded.\n * -  xms_ksl element, representing the storage location of the key's secret component on the client device. One of two values:\n *      - sw: software storage\n *      - uhw: hardware storage\n */\ntype ReqCnf = {\n    kid: string;\n    xms_ksl: KeyLocation;\n};\n\nenum KeyLocation {\n    SW = \"sw\",\n    UHW = \"uhw\"\n}\n\nexport class PopTokenGenerator {\n\n    private cryptoUtils: ICrypto;\n\n    constructor(cryptoUtils: ICrypto) {\n        this.cryptoUtils = cryptoUtils;\n    }\n\n    async generateCnf(request: SignedHttpRequestParameters): Promise<string> {\n        const reqCnf = await this.generateKid(request);\n        return this.cryptoUtils.base64Encode(JSON.stringify(reqCnf));\n    }\n\n    async generateKid(request: SignedHttpRequestParameters): Promise<ReqCnf> {\n        const kidThumbprint = await this.cryptoUtils.getPublicKeyThumbprint(request);\n\n        return {\n            kid: kidThumbprint,\n            xms_ksl: KeyLocation.SW\n        };\n    }\n\n    async signPopToken(accessToken: string, request: SignedHttpRequestParameters): Promise<string> {\n        const tokenClaims: TokenClaims | null = AuthToken.extractTokenClaims(accessToken, this.cryptoUtils);\n        if (!tokenClaims?.cnf?.kid) {\n            throw ClientAuthError.createTokenClaimsRequiredError();\n        }\n        \n        return this.signPayload(accessToken, tokenClaims.cnf.kid, request);\n    }\n\n    async signPayload(payload: string, kid: string, request: SignedHttpRequestParameters, claims?: object): Promise<string> {\n        // Deconstruct request to extract SHR parameters\n        const { resourceRequestMethod, resourceRequestUri, shrClaims, shrNonce } = request;\n\n        const resourceUrlString = (resourceRequestUri) ? new UrlString(resourceRequestUri) : undefined;\n        const resourceUrlComponents = resourceUrlString?.getUrlComponents();\n\n        return await this.cryptoUtils.signJwt({\n            at: payload,\n            ts: TimeUtils.nowSeconds(),\n            m: resourceRequestMethod?.toUpperCase(),\n            u: resourceUrlComponents?.HostNameAndPort,\n            nonce: shrNonce || this.cryptoUtils.createNewGuid(),\n            p: resourceUrlComponents?.AbsolutePath,\n            q: (resourceUrlComponents?.QueryString) ? [[], resourceUrlComponents.QueryString] : undefined,\n            client_claims: shrClaims || undefined,\n            ...claims\n        }, kid);\n    }\n}\n"]},"metadata":{},"sourceType":"module"}